# User Management System

## Overview

This application uses an **n8n hosted database** accessed via webhooks for user management. All user data is centralized in the n8n workflow system and accessed in real-time.

## Authentication

### 2-Step Slack Verification

The application uses a secure webhook-based authentication system:

1. **Cryptographic Hashing**: Secure hash generated from credentials with time-based component
2. **Webhook Verification**: Secure request to n8n with validation headers
3. **Slack Notification**: Rocky bot sends DM to user during login
4. **Authentication**: Webhook responds with user data if credentials are valid

**Example Login:**
- **Email:** `admin@wearehyrax.com`
- **Password:** [Generated by n8n, sent via Slack]
- **Process:** Enter credentials → Secure hash generated → Slack DM notification → Login approved

## How It Works

### Authentication Flow (`api/auth.js`)
1. User submits email and password
2. Client generates cryptographic hash with time-based security
3. Secure GET request to n8n webhook endpoint
   - Query params: `email`, `password`
   - Header: `x-hash-code: <validation hash>`
4. n8n validates credentials and sends Slack DM
5. Webhook responds with:
   ```json
   {
     "allowed": "yes",
     "name": "User Name",
     "role": "super-admin",
     "department": "DEV"
   }
   ```
6. Role normalized: "super-admin" → "super_admin"
7. User authenticated and session created

### User Management (`api/users.js` + Webhooks)

#### Fetching Users
- **Endpoint**: Secure n8n webhook (configured in environment)
- **Headers**: `x-hash-code` for verification
- **Returns**: Array of all users from n8n database
- **Implementation**: UserManagement.jsx fetches on component mount

#### Creating Users
- **Endpoint**: Secure n8n webhook (configured in environment)
- **Body**:
  ```json
  {
    "name": "New User",
    "email": "user@example.com",
    "role": "team_member",
    "department": "MEDIA BUYING",
    "admin_email": "admin@wearehyrax.com"
  }
  ```
- **Password**: Auto-generated by n8n and sent to user via Slack
- **Error Handling**: 400 errors parsed and displayed to admin

All operations interact directly with the n8n hosted database via webhooks.

## Deployment Notes

### ✅ Production-Ready Features

**No filesystem dependencies:**
- User data stored in n8n hosted database
- No local JSON files needed for users
- Real-time data synchronization across all instances
   - Use a real database (PostgreSQL, MongoDB, etc.)
   - Vercel offers integrations with various database providers
   - User data will truly persist

   **Option B: Vercel KV or Edge Config**
   - Use Vercel's KV storage (Redis-based)
   - Suitable for this use case with minimal code changes

   **Option C: Environment Variables (Limited)**
   - For very small user lists, store in environment variables
   - Not scalable beyond a few users

4. **For MVP/Demo Purposes:**
   - The current file-based approach works for demos
   - Users created will persist during the serverless function's lifetime
   - After cold starts, only users in the deployed `users.json` will exist

## Files Structure

```
server/data/
├── users.json      # Central user database
├── tasks.json      # Tasks data
└── campaigns.json  # Campaigns data

api/
├── auth.js         # Authentication endpoints
└── users.js        # User management CRUD
```

## Security Considerations

⚠️ **Current Implementation Notes:**
1. Passwords stored in plain text (use hashing in production)
2. Simple token-based auth (use JWT library in production)
3. No rate limiting on login attempts
4. CORS set to allow all origins (restrict in production)

## Future Enhancements

- [ ] Implement password hashing (bcrypt)
- [ ] Add proper JWT library
- [ ] Implement rate limiting
- [ ] Add password reset functionality
- [ ] Integrate with a persistent database
- [ ] Add user roles and permissions system
- [ ] Implement session management
